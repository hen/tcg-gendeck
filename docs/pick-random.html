<html>
    <head>
        <title>Generate Two Teams</title>
    </head>

    <body>
        <h1>Random Match-Up</h1>

        <p>Two random teams to play against each other. </p>


<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="tcg-lib.js"></script>

<script>

    var STAR='\u2b50';
    var MAX_STARS=25;

    function choose_team(data, filter) {

        var filtered_cards=[];
        
        // Filter based on a template
        $.each( data.records, function( idx, card ) {
            var should_filter=true;
            if(card.fields.Name=='Unknown Wave 4 Bot') {
                should_filter=false;
            }
            $.each( filter, function( attribute, match ) {
                if(Array.isArray(match)) {
                    if(!match.includes( card.fields[attribute] )) {
                        should_filter=false;
                    }
                } else {
                    if(card.fields[attribute] != match) {
                        should_filter=false;
                    }
                }
            });
            if(should_filter) {
                filtered_cards.push(card);
            }
        });

        // Choose a team from the filtered bots
        var chosen_cards=[];
        var current_stars=0;
        var calculating=true;

        var escape_counter=10;
        while(calculating) {
            chosen=filtered_cards[Math.floor(Math.random() * filtered_cards.length)];
            chosen_cards.push(chosen.fields.Name);
            filtered_cards = filtered_cards.filter( card => card != chosen );
            console.log("Added: " + chosen.fields.Name+"["+chosen.fields.Subtitle+"]("+chosen.fields[STAR]+")");

            current_stars += chosen.fields[STAR];

            remaining_stars = MAX_STARS - current_stars;

            if(remaining_stars == 0) {
                calculating = false;
            } else {

                filtered_cards = filtered_cards.filter( card => card.fields[STAR] <= remaining_stars );

                if(filtered_cards.length==0 && remaining_stars !=0) {
                    for (i = 0; i < remaining_stars; i++) { 
                        chosen_cards.push("Star Card");
                    }
                    calculating = false;
                }
                escape_counter-=1;
                if(escape_counter < 0) {
                    console.log("Looping too much; quitting");
                    calculating = false;
                }
            }
        }

        return chosen_cards;
    }

    function display_team(cards) {
        console.log(cards);
    }

/*
    // '\ud83e\udde1'
    // Name;
    // 'Alt Type(s)'
    // 'Role(s)'
    // Affiliation
    // Wave
    // Tribe
    // Rarity
    var filterB={
        "Set": "Wave 1",
        "Tribe": "Dinobot",
        "Rarity": ["Common", "Uncommon"],
    };
*/

    function page_load() {
        $.getJSON( "https://hen.github.io/tcg-gendeck/json/bot-cards.json", function( data ) {
            var default_search_params = new URLSearchParams();
            default_search_params.append('filterA.Set', 'Wave 1');
            default_search_params.append('filterA.Set', 'Wave 2');
            default_search_params.append('filterA.Set', 'Wave 3');
            default_search_params.append('filterA.Set', 'Wave 4');
            default_search_params.append('filterB.Set', 'Wave 1');
            default_search_params.append('filterB.Set', 'Wave 2');
            default_search_params.append('filterB.Set', 'Wave 3');
            default_search_params.append('filterB.Set', 'Wave 4');

            params=initialize_form_from_params("navbar", default_search_params);

            filterA=params_to_hash(params, 'filterA.');
            filterB=params_to_hash(params, 'filterB.');

            var cardsA=choose_team(data, filterA);
            display_team(cardsA);
            var cardsB=choose_team(data, filterB);
            display_team(cardsB);
        });
    }
</script>

        <form id="navbar" onSubmit="">
            <h3>Team A</h3>
            <label>Wave 1: </label><input type='checkbox' name='filterA.Set' value='Wave 1'/>
            <label>Wave 2: </label><input type='checkbox' name='filterA.Set' value='Wave 2'/>
            <label>Wave 3: </label><input type='checkbox' name='filterA.Set' value='Wave 3'/>
            <label>Wave 4: </label><input type='checkbox' name='filterA.Set' value='Wave 4'/>
            <h3>Team B</h3>
            <label>Wave 1: </label><input type='checkbox' name='filterB.Set' value='Wave 1'/>
            <label>Wave 2: </label><input type='checkbox' name='filterB.Set' value='Wave 2'/>
            <label>Wave 3: </label><input type='checkbox' name='filterB.Set' value='Wave 3'/>
            <label>Wave 4: </label><input type='checkbox' name='filterB.Set' value='Wave 4'/>
            <input type='submit' value='Generate'/>
        </form>

      <script>
          page_load();
      </script>


    </body>
</html>
